---
title: "Flow and temperature effects on juvenile Winter-run survival"
subtitle: "Prepared for Cramer Fish Sciences"
author: "Matt Espe"
date: "2022 Nov 29"
header-includes:
- \usepackage{pdflscape}
output: "pdf_document"
---


```{r echo = FALSE}
#source("R/model_data.R")
```
# Methods

## Data preparation

- SAC river temperatures were used to estimate temperature-based survival effects:
  - There was insufficient data from SAC to cover then entire study
    period. To fill out the time-series to cover the entire study
    period, the SAC data was estimated via linear interpolation using
    two nearby sites (KWK and CCR).	
  - For each monthly "cohort", the river temperatures at SAC were
    averaged for the spawning month plus two months following (3
    months total).
  - Using this average temperature for the spawning period, a
    calculated survival for the cohort was calculated according to
    either the IOS or Martin equations.
  - These survival estimates were then averaged using a weighted
    average to give an annual estimate for the temperature-based
    survival, with the weights being the proportion of spawners for
    that month. For years where we do not have monthly spawner data,
    we used the average distribution across all years.

- A similar procedure as used to create a cohort-weighted average for
  river flow, covering the spawning month plus three months, and
  average temperature and number of days above 53/56 F, covering the
  spawning month plus two months.

- For ease of interpretation, the number of eggs and year were
  converted to z-scores(i.e. scaled). This transformation helps when
  there are vast differences in the magnitude of model
  predictors. Under this transformation, the model estimates are
  interpreted as a amount change per 1 stdev change in the predictor.

## Modeling

### Basic Model Form

The JPI is the primary metric of interest. We assume a standard Ricker relationship,

$$ R = S * exp(\alpha - \beta*S + \lambda*F) $$

where R is the Juvenile Production Index, S is the density of eggs,
and F is an environmental variable.

Converted to a linear form, we have:

$$ log(R/S) = \alpha + \beta * S + \lambda * F $$

where the response, log(R/S), is the log of survival rate. In this
formulation, environmental effects have and additive effect on the
quantity $ log(R/S) $.

### Model Comparison

To find the model with the best predictive performance, we compared
nested models with the following predictors:

- Estimated temperature-based cohort-weighted survival, either:
  - via IOS equation or,
  - via Martin equation
- Cohort-weighted flow at Bend Bridge
- Year
- Estimated number of eggs
- Weighted sum of number of days with average water temperature greater or equal to:
  - 53 F or 
  - 56 F
- Spawn DO
- Water temperature for:
  - egg stage, or
  - fry stage
- Water flow for:
  - egg stage, or 
  - fry stage
- Number of days during fry stage with low flow

Competing models, from simplest to most complex, were fit using the
`lm()` function in R. Models were compared using the `anova()`
function, and goodness-of-fit was evaluated using the AICc via the
`aictab()` function from the `AICcmovavg` package.  The AICc
(AIC-corrected) was used to evaluate model predictive performance, as
it is generally prefered to the AIC in small-dataset cases (< 40 obs).
In all, 21 models were evaluated. Models containing interaction terms
were not compared.

# Results

The best performing model according to AICc took the form:

$$ log(R/S) = \alpha + \beta * S + \beta_{flow\_weighted} * flow\_weighted + \beta_{martin} * surv\_martin $$

This performed slightly better than a competing model containing the
flow at spawning time and the number of days with average temperatures
above 53F. This was expected due to correlations between the
cohort-weighted flow and the flow at spawning time, and between the
Martin metric of egg mortality and the number of days with average
temperatures above 53F. Full results for every model evaluated are
available in Table 3.

The estimates from the best performing model were:

```{=latex}
% latex table generated in R 4.2.2 by xtable 1.8-4 package
% Mon Nov 28 18:15:48 2022
\begin{table}[ht]
\caption{Model parameter estimates for the model with the highest predictive performance (according to AICc).} 
\centering
\begin{tabular}{lrrrr}
  \hline
 & Estimate & Std. Error & t value & Pr($>$$|$t$|$) \\ 
  \hline
(Intercept) & -1.6946 & 0.0680 & -24.91 & 0.0000 \\ 
  Eggs (scaled) & -0.3461 & 0.0733 & -4.72 & 0.0001 \\ 
  Flow (weighted and scaled) & 0.4072 & 0.0956 & 4.26 & 0.0004 \\ 
  Martin surv. (weighted and scaled) & 0.3784 & 0.0919 & 4.12 & 0.0005 \\ 
   \hline
\end{tabular}
\end{table}
```

Inspection of the diagnostic plots for the best performing model
revealed two points with significant leverage (i.e. large influence on
regression estimates). These two points were the years 1998
and 2022. To explore the potential impact of these points, univariate
plots with simple regression lines were created, with the two points
with high leverage coded in red.

![Univariate plots of predictors vs. log(R/S). Points with high leverage are colored red](single_var.png)

It becomes clear that the estimate of flow is being strongly
influenced by these two years. Removing one of these years (either
1998 or 2022) makes flow no longer predictive. Therefore, caution is
advised in interpreting the relationship to flow until more data is
available.

For the best model, the proportion of variance explained by each
predictor was calculated via the CAR method of R2 decomposition (Zuber
and Strimmer 2010). This showed that the Martin et al. egg mortality metric
explained the most variation, followed by flow and the number of eggs.

```{=latex}
% latex table generated in R 4.2.2 by xtable 1.8-4 package
% Tue Nov 29 10:28:26 2022
\begin{table}[ht]
\caption{Proportion of R2 explained by each predictor(via the CAR method; Zuber and Strimmer 2010) in the model with the highest predictive performance (according to AICc).} 
\centering
\begin{tabular}{lrr}
  \hline
Predictor & Prop. R2 explained & Rank \\ 
  \hline
Eggs (scaled) & 0.13 & 3 \\ 
Flow (weighted and scaled) & 0.34 & 2 \\ 
Martin surv. (weighted and scaled) & 0.40 & 1 \\ 
   \hline
\end{tabular}
\end{table}
```

## Caveats 

All analyses presented here are focused on predictive performance, and
do not imply causal relationships. The best performing model(s) might
suggest areas of future study, but make no claims in regards to what
factors are causing lower or higher survival for Winter-run salmon.

The dataset used to create these models is small (24 obs). Attempts
have been made to mitigate this (e.g. using the AICc to compare
models), but all conclusions rest on the assumption that these data
are representative. If future data are significantly different from
the 24 years used here, the conclusions are likely to change.

There are two years with outsized influence on the estimates presented
here, 1998 and 2022. It is possible that additional data will mitigate
the influence of these years and can change the relative importance of
predictors or models.


\newpage
```{=latex}
\begin{landscape}
% latex table generated in R 4.2.2 by xtable 1.8-4 package
% Tue Nov 29 10:12:06 2022
\begin{table}[ht]
\caption{Ranked model predictive performance, according to AICc. Models at the with lower AICc are expected to perform better when predicting out-of-sample data.}
\centering
\begin{tabular}{|p{0.6\linewidth}|r|r|r|r|r|}
  \hline
Model & K & AICc & Delta AICc & AICc weight & log-Likelihood \\ 
  \hline
log(R/S) \~{} Eggs + Flow (weighted) + Martin surv. (weighted) &   5 & 24.26 & 0.00 & 0.59 & -5.46 \\ 
   \hline
log(R/S) \~{} Eggs + Martin surv. (weighted) + N days over 53F + Spawn Flow &   6 & 26.49 & 2.23 & 0.19 & -4.77 \\ 
   \hline
log(R/S) \~{} Eggs + Year + Martin surv. (weighted) + Flow (weighted) &   6 & 27.17 & 2.91 & 0.14 & -5.11 \\ 
   \hline
log(R/S) \~{} Eggs + IOS surv. (weighted) + Flow (weighted) &   5 & 29.75 & 5.49 & 0.04 & -8.21 \\ 
   \hline
log(R/S) \~{} Eggs + Year + IOS surv. (weighted) + Flow (weighted) &   6 & 31.80 & 7.54 & 0.01 & -7.43 \\ 
   \hline
log(R/S) \~{} Eggs + Year + Martin surv. (weighted) &   5 & 32.30 & 8.04 & 0.01 & -9.48 \\ 
   \hline
log(R/S) \~{} Year + Eggs + Martin surv. (weighted) + N days over 53F + Spawn DO + Fry Temp + Fry Low Flow Days &   9 & 32.63 & 8.37 & 0.01 & -0.89 \\ 
   \hline
log(R/S) \~{} Eggs + Year + IOS surv. (weighted) &   5 & 35.22 & 10.95 & 0.00 & -10.94 \\ 
   \hline
log(R/S) \~{} Eggs + Martin surv. (weighted) &   4 & 36.51 & 12.25 & 0.00 & -13.20 \\ 
   \hline
log(R/S) \~{} Year + Eggs + IOS surv. (weighted) + Martin surv. (weighted) + N days over 53F + Spawn DO + Fry Temp + Fry Low Flow Days &  10 & 37.43 & 13.17 & 0.00 & -0.25 \\ 
   \hline
log(R/S) \~{} Eggs + Year + Flow (weighted) &   5 & 38.99 & 14.73 & 0.00 & -12.83 \\ 
   \hline
log(R/S) \~{} Eggs + Year + temp raw (weighted) &   5 & 43.54 & 19.28 & 0.00 & -15.10 \\ 
   \hline
log(R/S) \~{} Year + Eggs + IOS surv. (weighted) + Martin surv. (weighted) + N days over 53F + Spawn DO + Fry Temp + Spawn Flow + Fry Low Flow Days &  11 & 44.36 & 20.10 & 0.00 & -0.18 \\ 
   \hline
log(R/S) \~{} Year + Eggs + Flow (weighted) + IOS surv. (weighted) + Martin surv. (weighted) + N days over 53F + Spawn DO + Fry Temp + Spawn Flow + Fry Low Flow Days &  12 & 51.56 & 27.30 & 0.00 & 0.40 \\ 
   \hline
log(R/S) \~{} Eggs + Year &   4 & 56.28 & 32.02 & 0.00 & -23.09 \\ 
   \hline
log(R/S) \~{} Year &   3 & 57.59 & 33.33 & 0.00 & -25.19 \\ 
   \hline
log(R/S) \~{} Year + Eggs + Flow (weighted) + IOS surv. (weighted) + Martin surv. (weighted) + N days over 53F + N days over 56F + Spawn DO + Fry Temp + Spawn Flow + Fry Low Flow Days &  13 & 60.80 & 36.54 & 0.00 & 0.80 \\ 
   \hline
log(R/S) \~{} 1 &   2 & 62.43 & 38.17 & 0.00 & -28.93 \\ 
   \hline
log(R/S) \~{} Eggs &   3 & 63.07 & 38.81 & 0.00 & -27.94 \\ 
   \hline
log(R/S) \~{} Year + Eggs + Flow (weighted) + IOS surv. (weighted) + Martin surv. (weighted) + N days over 53F + N days over 56F + Spawn DO + Fry Temp + Spawn Flow + Fry Flow + Fry Low Flow Days &  14 & 73.02 & 48.76 & 0.00 & 0.82 \\ 
   \hline
log(R/S) \~{} Year + Eggs + Flow (weighted) + IOS surv. (weighted) + Martin surv. (weighted) + N days over 53F + N days over 56F + Spawn Turbidity + Spawn DO + Fry Temp + Spawn Flow + Fry Flow + Fry Low Flow Days &  15 & 88.34 & 64.08 & 0.00 & 0.83 \\ 
   \hline
\end{tabular}
\end{table}
\end{landscape}
```
